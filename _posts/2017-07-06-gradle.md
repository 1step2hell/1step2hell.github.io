---
layout: post
title:  "Gradle"
date:   2017-07-07 13:30:00 +0800
categories: Android
tags: Gradle
published: true
---

* content
{:toc}


# Gradle
很自信地说,这大概是目前网上能搜到的最全最通俗易懂的[Gradle](https://gradle.org/)介绍了.  
如果读完觉得对你的工作有帮助,请右上角捐赠.一两分我不会嫌弃,三五百我也不会脸红.  
只是希望大家建立一个为知识付费的意识,写这篇文章耗费了两天时间,斟斟酌酌、仔仔细细,生怕误了后来人,恰逢这几天感冒,生不如死,堪比大妈难产.  

感谢[明子](http://www.goinbowl.com/),我的gradle还是明子带入门的,话说明子你写的那两篇gradle啥玩意儿呀,能不能认真点,我擦.  
最后,绝对原创,欢迎纠错,欢迎推荐,:u7981:止转载,谢谢!

# Installation
gradle安装包官网下载地址<https://services.gradle.org/distributions/>.  
安装gradle有两种方式:  
* 手动下载存放本地即可.  
* 通过Android Studio项目里的gradle wrapper.  
  gradle wrapper包含几个以下几个重要文件:  
  * gradlew (Unix Shell script)
  * gradlew.bat (Windows batch file)
  * gradle/wrapper/gradle-wrapper.jar (Wrapper JAR)
  * gradle/wrapper/gradle-wrapper.properties (Wrapper properties)

  其中文件gradle-wrapper.properties指定要下载的gradle版本地址以及存放路劲:  
  ```
  #Fri Jul 07 21:03:26 CST 2017
  distributionBase=GRADLE_USER_HOME
  distributionPath=wrapper/dists
  zipStoreBase=GRADLE_USER_HOME
  zipStorePath=wrapper/dists
  distributionUrl=https\://services.gradle.org/distributions/gradle-3.5.1-bin.zip

  ```
  该文件指定的版本号同时对应Project Structure -> Project -> Gradle version:  
  ![/styles/images/gradle/gradle-wrapper-properties.png]({{'/styles/images/gradle/gradle-wrapper-properties.png'|prepend:site.baseurl}})

  gradle-wrapper.jar是执行下载任务的jar包:  
  ![/styles/images/gradle/gradle-wrapper-jar.png]({{'/styles/images/gradle/gradle-wrapper-jar.png'|prepend:site.baseurl}})  
  通过执行task: `gradle wrapper` 就可以下载下来,默认存放在本地目录:$USER_HOME/.gradle/wrapper/dists.  
  当然也可以命令指定版本号(以版本3.5为例):`gradle wrapper --gradle-version 3.5`,一般默认下载都是最小发行版bin包,但是Android Studio会下载带src的全包,可以在命令里制定下载类型,只需要添加参数:--distribution-type,甚至还可以指定下载url,使用参数--gradle-distribution-url.

以上两种Gradle安装方式对应着Android Studio -> Settings -> Gradle -> Project-level settings
![/styles/images/gradle/settings-gradle.png]({{ '/styles/images/gradle/settings-gradle.png' | prepend: site.baseurl  }})  
* User local gradle distribution: 选择该选项,填入手动下载的gradle存放路劲.  
* Use default gradle wrapper(recommended): 选择该项,Android Studio会自动执行task(gradle wrapper)去下载gradle.这下知道为什么新建一个项目会卡在初始化界面半天了哇,因为默认就是这个选项.

# Download Dependencies
当我们修改了module的build.gradle脚本的时候,Android Studio会自动提示sync,sync的作用就是对我们的修改做出相应变化使之生效.其中最主要做的一件事就是下载依赖包.如果我们在dependencies{ }模块添加了依赖,同时本地对应的gradle路劲又没有该依赖,那么sync的时候gradle就会去网络上下载,下载的地址基于项目一级的build.gradle脚本:  
```
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:2.3.3'

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        jcenter()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
```
Ivy、Maven 和 Gradle 管理库和依赖包都是这种方式,公司提前把库存放在网络的仓库里(比如jcenter maven),对于需要依赖包的项目再从网络上下载.  
这种工作方式的前提是Android Studio -> Settings -> Gradle -> Global Gradle Settings(参考Project-level settings示例一图)没有勾选Offline work,如果勾选了Offline work,指定本地路劲作为Service directory path,则gradle sync的时候不会从网络下载对应的库和依赖包,而是去Offline work指定的路劲找.如果指定的路劲找不到,sync失败.  
当然,我也不知道Google给这么个选项在什么情况下勾选使用,谨慎猜测是为了个人使用一些不方便上传网络的私有库,毕竟如果只是为了保密,公司可以选择自己搭个依赖包的私有服务器,然后把build.gradle脚本的jcenter换成自己的服务器地址,服务器保存私有库的同时定期更新jcenter的仓库.  
总之,如果不懂不要理会这个选项,默认不勾选就好.千万不要手贱,千万不要手贱,重要的事不说三遍!

# Gradle & Gradle plugin  
继续分析上面project的build.gradle脚本,这个脚本里包含三个模块(block).  
先说最简单的第三个:  
```
task clean(type: Delete) {
    delete rootProject.buildDir
}
```
一眼就能看出是在设置任务clean的时候删除project根目录下的build文件夹.  

再看第一个模块buildscript:  
```
buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:2.3.3'

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}
```
这个模块用于指定gradle自身build所需的依赖以及下载地址.  
有点懵逼哈,其实很好理解,gradle这个软件在build的时候也是需要从网络下载依赖包的,这里依赖的是gradle plugin(官方的说法是Android plugin for gradle).  
每一版本gradle依赖的gradle plugin版本号都是有范围的,或者说gradle plugin的每一次版本升级都只会适配较新版本的gradle,两者具体的版本匹配关系可参考  
<https://developer.android.google.cn/studio/releases/gradle-plugin.html#updating-plugin>.  

第二个模块:  
```
allprojects {
    repositories {
        jcenter()
    }
}
```
这里就指定了项目所需依赖的下载地址(具体需要的依赖包声明在了module的build.gradle脚本里),如果下载依赖使用私有的库服务器,修改这里的地址.  

这两个模块同时也对应Project Structure -> Project的选项:  
![/styles/images/gradle/module-build-gradle.png]({{ '/styles/images/gradle/module-build-gradle.png' | prepend: site.baseurl  }})

# build.gradle of module
To be continue...
